define("graphics/webgl/GraphicsRenderer",["mmvis","../../const","./WebGLGraphicsData","./shaders/PrimitiveShader","./utils/buildPoly","./utils/buildRectangle","./utils/buildCircle"],function(t,r,e){"use strict";r.__esModule=!0;var a=t("mmvis"),i=t("../../const"),s=t("./WebGLGraphicsData"),l=t("./shaders/PrimitiveShader"),d=t("./utils/buildPoly"),h=t("./utils/buildRectangle"),n=t("./utils/buildCircle"),o=function(){function t(t){this.renderer=t,this.graphicsDataPool=[],this.primitiveShader=null,this.gl=t.gl,this.CONTEXT_UID=0}return t.prototype.onContextChange=function(){this.gl=this.renderer.gl,this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.primitiveShader=new l.default(this.gl)},t.prototype.destroy=function(){this.renderer=null;for(var t=0;t<this.graphicsDataPool.length;++t)this.graphicsDataPool[t].destroy();this.graphicsDataPool=null},t.prototype.render=function(t,r){var e,i=this.renderer,s=i.gl,l=t.graphics,d=l._webGL[this.CONTEXT_UID];d&&l.dirty===d.dirty||(this.updateGraphics(l),d=l._webGL[this.CONTEXT_UID]);var h=this.primitiveShader;i.bindShader(h);for(var n=0,o=d.data.length;n<o;n++){var p=(e=d.data[n]).shader;i.bindShader(p),p.uniforms.translationMatrix=t.worldTransform.toArray(!0),p.uniforms.tint=a.color.hexTorgb(l.tint),p.uniforms.alpha=l.worldAlpha,i.bindVao(e.vao),e.vao.draw(s.TRIANGLE_STRIP,e.indices.length)}},t.prototype.updateGraphics=function(t){var r,e=this.renderer.gl,a=t._webGL[this.CONTEXT_UID];if(a||(a=t._webGL[this.CONTEXT_UID]={lastIndex:0,data:[],gl:e,clearDirty:-1,dirty:-1}),a.dirty=t.dirty,t.clearDirty!==a.clearDirty){a.clearDirty=t.clearDirty;for(var s=0;s<a.data.length;s++)this.graphicsDataPool.push(a.data[s]);a.data.length=0,a.lastIndex=0}for(s=a.lastIndex;s<t.graphicsData.length;s++){var l=t.graphicsData[s];r=this.getWebGLData(a,0),l.type===i.SHAPES.POLY&&d.default(l,r),l.type===i.SHAPES.RECT?h.default(l,r):l.type!==i.SHAPES.CIRC&&l.type!==i.SHAPES.ELIP||n.default(l,r),a.lastIndex++}this.renderer.bindVao(null);for(s=0;s<a.data.length;s++)(r=a.data[s]).dirty&&r.upload()},t.prototype.getWebGLData=function(t,r){var e=t.data[t.data.length-1];return(!e||e.points.length>32e4)&&((e=this.graphicsDataPool.pop()||new s.default(this.renderer.gl,this.primitiveShader,this.renderer.state.attribsState)).reset(r),t.data.push(e)),e.dirty=!0,e},t}();r.default=o});