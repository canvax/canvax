define("display/Text",["./DisplayObject","../utils/index","mmvis"],function(t,e,i){"use strict";var n,o=this&&this.__extends||(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},function(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});e.__esModule=!0;var r=t("./DisplayObject"),s=t("../utils/index"),h=t("mmvis"),l=function(t){function e(e,i){var n=this;return i.type="text",null!==e&&void 0!==e||(e=""),i.context=h._.extend({font:"",fontSize:13,fontWeight:"normal",fontFamily:"\u5fae\u8f6f\u96c5\u9ed1,sans-serif",textBaseline:"top",textAlign:"left",textDecoration:null,fillStyle:"blank",strokeStyle:null,lineWidth:0,lineHeight:1.2,backgroundColor:null,textBackgroundColor:null},i.context),(n=t.call(this,i)||this)._reNewline=/\r?\n/,n.fontProperts=["fontStyle","fontVariant","fontWeight","fontSize","fontFamily"],n.context.font=n._getFontDeclaration(),n.text=e.toString(),n.context.width=n.getTextWidth(),n.context.height=n.getTextHeight(),n}return o(e,t),e.prototype.$watch=function(t,e,i){h._.indexOf(this.fontProperts,t)>=0&&(this.context[t]=e,this.context.font=this._getFontDeclaration(),this.context.width=this.getTextWidth(),this.context.height=this.getTextHeight())},e.prototype._setContextStyle=function(t,e,i){for(var n in e)"textBaseline"!=n&&n in t&&(e[n]||h._.isNumber(e[n]))&&("globalAlpha"==n?t.globalAlpha=i:t[n]=e[n])},e.prototype.render=function(t,e){this._renderText(t,this._getTextLines(),e)},e.prototype.resetText=function(t){this.text=t.toString(),this.heartBeat()},e.prototype.getTextWidth=function(){var t=0;return s.default._pixelCtx&&(s.default._pixelCtx.save(),s.default._pixelCtx.font=this.context.$model.font,t=this._getTextWidth(s.default._pixelCtx,this._getTextLines()),s.default._pixelCtx.restore()),t},e.prototype.getTextHeight=function(){return this._getTextHeight(s.default._pixelCtx,this._getTextLines())},e.prototype._getTextLines=function(){return this.text.split(this._reNewline)},e.prototype._renderText=function(t,e,i){t&&(t.save(),this._setContextStyle(t,this.context.$model,i),this._renderTextStroke(t,e),this._renderTextFill(t,e),t.restore())},e.prototype._getFontDeclaration=function(){var t=this,e=[];return h._.each(this.fontProperts,function(i){var n=t.context[i];"fontSize"==i&&(n=parseFloat(n)+"px"),n&&e.push(n)}),e.join(" ")},e.prototype._renderTextFill=function(t,e){if(this.context.$model.fillStyle){this._boundaries=[];for(var i=0,n=0,o=e.length;n<o;n++){i+=this._getHeightOfLine(t,n,e),this._renderTextLine("fillText",t,e[n],0,this._getTopOffset()+i,n)}}},e.prototype._renderTextStroke=function(t,e){if(t&&this.context.$model.strokeStyle&&this.context.$model.lineWidth){var i=0;t.save(),this.strokeDashArray&&(1&this.strokeDashArray.length&&this.strokeDashArray.push.apply(this.strokeDashArray,this.strokeDashArray),supportsLineDash&&t.setLineDash(this.strokeDashArray)),t.beginPath();for(var n=0,o=e.length;n<o;n++){i+=this._getHeightOfLine(t,n,e),this._renderTextLine("strokeText",t,e[n],0,this._getTopOffset()+i,n)}t.closePath(),t.restore()}},e.prototype._renderTextLine=function(t,e,i,n,o,r){if(o-=this._getHeightOfLine()/4,"justify"===this.context.$model.textAlign){var s=e.measureText(i).width,h=this.context.$model.width;if(h>s)for(var l=i.split(/\s+/),a=(h-e.measureText(i.replace(/\s+/g,"")).width)/(l.length-1),x=0,f=0,c=l.length;f<c;f++)this._renderChars(t,e,l[f],n+x,o,r),x+=e.measureText(l[f]).width+a;else this._renderChars(t,e,i,n,o,r)}else this._renderChars(t,e,i,n,o,r)},e.prototype._renderChars=function(t,e,i,n,o){e[t](i,0,o)},e.prototype._getHeightOfLine=function(){return this.context.$model.fontSize*this.context.$model.lineHeight},e.prototype._getTextWidth=function(t,e){for(var i=t.measureText(e[0]||"|").width,n=1,o=e.length;n<o;n++){var r=t.measureText(e[n]).width;r>i&&(i=r)}return i},e.prototype._getTextHeight=function(t,e){return this.context.$model.fontSize*e.length*this.context.$model.lineHeight},e.prototype._getTopOffset=function(){var t=0;switch(this.context.$model.textBaseline){case"top":t=0;break;case"middle":t=-this.context.$model.height/2;break;case"bottom":t=-this.context.$model.height}return t},e.prototype.getRect=function(){var t=this.context,e=0,i=0;return"center"==t.textAlign&&(e=-t.width/2),"right"==t.textAlign&&(e=-t.width),"middle"==t.textBaseline&&(i=-t.height/2),"bottom"==t.textBaseline&&(i=-t.height),{x:e,y:i,width:t.width,height:t.height}},e}(r.default);e.default=l});