"use strict";!function(e,r){if("function"==typeof define&&define.amd)define(["exports","mmvis","../../const","../../renderers/webgl/WebGLRenderer","./WebGLGraphicsData","./shaders/PrimitiveShader","./utils/buildPoly","./utils/buildRectangle","./utils/buildCircle"],r);else if("undefined"!=typeof exports)r(exports,require("mmvis"),require("../../const"),require("../../renderers/webgl/WebGLRenderer"),require("./WebGLGraphicsData"),require("./shaders/PrimitiveShader"),require("./utils/buildPoly"),require("./utils/buildRectangle"),require("./utils/buildCircle"));else{var t={};r(t,e.mmvis,e._const,e.WebGLRenderer,e.WebGLGraphicsData,e.PrimitiveShader,e.buildPoly,e.buildRectangle,e.buildCircle),e.undefined=t}}(void 0,function(e,h,d,r,t,i,a,n,l){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;p(r);var s=p(t),o=p(i),u=p(a),c=p(n),f=p(l);function p(e){return e&&e.__esModule?e:{default:e}}function g(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var v,b,y,D=(v=P,(b=[{key:"onContextChange",value:function(){this.gl=this.renderer.gl,this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.primitiveShader=new o.default(this.gl)}},{key:"destroy",value:function(){this.renderer=null;for(var e=0;e<this.graphicsDataPool.length;++e)this.graphicsDataPool[e].destroy();this.graphicsDataPool=null}},{key:"render",value:function(e){var r,t=this.renderer,i=t.gl,a=e.graphics,n=a._webGL[this.CONTEXT_UID];n&&a.dirty===n.dirty||(this.updateGraphics(a),n=a._webGL[this.CONTEXT_UID]);var l=this.primitiveShader;t.bindShader(l);for(var s=0,d=n.data.length;s<d;s++){var o=(r=n.data[s]).shader;t.bindShader(o),o.uniforms.translationMatrix=e.worldTransform.toArray(!0),o.uniforms.tint=h.color.hexTorgb(a.tint),o.uniforms.alpha=a.worldAlpha,t.bindVao(r.vao),r.vao.draw(i.TRIANGLE_STRIP,r.indices.length)}}},{key:"updateGraphics",value:function(e){var r,t=this.renderer.gl,i=e._webGL[this.CONTEXT_UID];if((i=i||(e._webGL[this.CONTEXT_UID]={lastIndex:0,data:[],gl:t,clearDirty:-1,dirty:-1})).dirty=e.dirty,e.clearDirty!==i.clearDirty){i.clearDirty=e.clearDirty;for(var a=0;a<i.data.length;a++)this.graphicsDataPool.push(i.data[a]);i.data.length=0,i.lastIndex=0}for(var n=i.lastIndex;n<e.graphicsData.length;n++){var l=e.graphicsData[n];r=this.getWebGLData(i,0),l.type===d.SHAPES.POLY&&(0,u.default)(l,r),l.type===d.SHAPES.RECT?(0,c.default)(l,r):l.type!==d.SHAPES.CIRC&&l.type!==d.SHAPES.ELIP||(0,f.default)(l,r),i.lastIndex++}this.renderer.bindVao(null);for(var s=0;s<i.data.length;s++)(r=i.data[s]).dirty&&r.upload()}},{key:"getWebGLData",value:function(e,r){var t=e.data[e.data.length-1];return(!t||32e4<t.points.length)&&((t=this.graphicsDataPool.pop()||new s.default(this.renderer.gl,this.primitiveShader,this.renderer.state.attribsState)).reset(r),e.data.push(t)),t.dirty=!0,t}}])&&g(v.prototype,b),void(y&&g(v,y)),P);function P(e){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,P),this.renderer=e,this.graphicsDataPool=[],this.primitiveShader=null,this.gl=e.gl,this.CONTEXT_UID=0}e.default=D});