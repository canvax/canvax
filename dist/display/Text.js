"use strict";!function(t,e){if("function"==typeof define&&define.amd)define(["exports","./DisplayObject","../utils/index","mmvis"],e);else if("undefined"!=typeof exports)e(exports,require("./DisplayObject"),require("../utils/index"),require("mmvis"));else{var n={};e(n,t.DisplayObject,t.index,t.mmvis),t.undefined=n}}(void 0,function(t,e,n,o){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=s(e),r=s(n);function s(t){return t&&t.__esModule?t:{default:t}}function l(t){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function a(t,e){return!e||"object"!==l(e)&&"function"!=typeof e?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):e}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function f(t,e){return(f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var c,x,d,g=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&f(t,e)}(y,i.default),c=y,(x=[{key:"$watch",value:function(t,e){0<=o._.indexOf(this.fontProperts,t)&&(this.context[t]=e,this.context.font=this._getFontDeclaration(),this.context.width=this.getTextWidth(),this.context.height=this.getTextHeight())}},{key:"_setContextStyle",value:function(t,e,n){for(var i in e)"textBaseline"!=i&&i in t&&(e[i]||o._.isNumber(e[i]))&&("globalAlpha"==i?t.globalAlpha=n:t[i]=e[i])}},{key:"render",value:function(t,e){this._renderText(t,this._getTextLines(),e)}},{key:"resetText",value:function(t){this.text=t.toString(),this.heartBeat()}},{key:"getTextWidth",value:function(){var t=0;return r.default._pixelCtx&&(r.default._pixelCtx.save(),r.default._pixelCtx.font=this.context.$model.font,t=this._getTextWidth(r.default._pixelCtx,this._getTextLines()),r.default._pixelCtx.restore()),t}},{key:"getTextHeight",value:function(){return this._getTextHeight(r.default._pixelCtx,this._getTextLines())}},{key:"_getTextLines",value:function(){return this.text.split(this._reNewline)}},{key:"_renderText",value:function(t,e,n){t&&(t.save(),this._setContextStyle(t,this.context.$model,n),this._renderTextStroke(t,e),this._renderTextFill(t,e),t.restore())}},{key:"_getFontDeclaration",value:function(){var n=this,i=[];return o._.each(this.fontProperts,function(t){var e=n.context[t];"fontSize"==t&&(e=parseFloat(e)+"px"),e&&i.push(e)}),i.join(" ")}},{key:"_renderTextFill",value:function(t,e){if(this.context.$model.fillStyle){this._boundaries=[];for(var n=0,i=0,o=e.length;i<o;i++)n+=this._getHeightOfLine(t,i,e),this._renderTextLine("fillText",t,e[i],0,this._getTopOffset()+n,i)}}},{key:"_renderTextStroke",value:function(t,e){if(t&&this.context.$model.strokeStyle&&this.context.$model.lineWidth){var n=0;t.save(),this.strokeDashArray&&(1&this.strokeDashArray.length&&this.strokeDashArray.push.apply(this.strokeDashArray,this.strokeDashArray),supportsLineDash&&t.setLineDash(this.strokeDashArray)),t.beginPath();for(var i=0,o=e.length;i<o;i++)n+=this._getHeightOfLine(t,i,e),this._renderTextLine("strokeText",t,e[i],0,this._getTopOffset()+n,i);t.closePath(),t.restore()}}},{key:"_renderTextLine",value:function(t,e,n,i,o,r){if(o-=this._getHeightOfLine()/4,"justify"===this.context.$model.textAlign){var s=e.measureText(n).width,l=this.context.$model.width;if(s<l)for(var h=n.split(/\s+/),a=(l-e.measureText(n.replace(/\s+/g,"")).width)/(h.length-1),u=0,f=0,c=h.length;f<c;f++)this._renderChars(t,e,h[f],i+u,o,r),u+=e.measureText(h[f]).width+a;else this._renderChars(t,e,n,i,o,r)}else this._renderChars(t,e,n,i,o,r)}},{key:"_renderChars",value:function(t,e,n,i,o){e[t](n,0,o)}},{key:"_getHeightOfLine",value:function(){return this.context.$model.fontSize*this.context.$model.lineHeight}},{key:"_getTextWidth",value:function(t,e){for(var n=t.measureText(e[0]||"|").width,i=1,o=e.length;i<o;i++){var r=t.measureText(e[i]).width;n<r&&(n=r)}return n}},{key:"_getTextHeight",value:function(t,e){return this.context.$model.fontSize*e.length*this.context.$model.lineHeight}},{key:"_getTopOffset",value:function(){var t=0;switch(this.context.$model.textBaseline){case"top":t=0;break;case"middle":t=-this.context.$model.height/2;break;case"bottom":t=-this.context.$model.height}return t}},{key:"getRect",value:function(){var t=this.context,e=0,n=0;return"center"==t.textAlign&&(e=-t.width/2),"right"==t.textAlign&&(e=-t.width),"middle"==t.textBaseline&&(n=-t.height/2),"bottom"==t.textBaseline&&(n=-t.height),{x:e,y:n,width:t.width,height:t.height}}}])&&h(c.prototype,x),void(d&&h(c,d)),y);function y(t,e){var n;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,y),e.type="text",null==t&&(t=""),e.context=o._.extend({font:"",fontSize:13,fontWeight:"normal",fontFamily:"微软雅黑,sans-serif",textBaseline:"top",textAlign:"left",textDecoration:null,fillStyle:"blank",strokeStyle:null,lineWidth:0,lineHeight:1.2,backgroundColor:null,textBackgroundColor:null},e.context),(n=a(this,u(y).call(this,e)))._reNewline=/\r?\n/,n.fontProperts=["fontStyle","fontVariant","fontWeight","fontSize","fontFamily"],n.context.font=n._getFontDeclaration(),n.text=t.toString(),n.context.width=n.getTextWidth(),n.context.height=n.getTextHeight(),n}t.default=g});